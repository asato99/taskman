# プロセスインスタンス管理コマンド結合テスト仕様

## 概要

プロセスインスタンス管理コマンドの結合テストでは、以下の機能をテストします：

- データベースへのプロセスインスタンス情報の保存と取得
- プロセスインスタンスの作成、表示、更新、削除の一連の流れ
- プロセスインスタンスとプロセス定義の連携
- タスクとの連携
- バリデーションエラーの処理

この結合テストでは実際のデータベースアクセスを伴う処理をテストし、コマンドの機能が想定通りに動作することを確認します。

## テスト環境

- 一時的なSQLiteデータベースを使用
- 各テスト実行時にデータベースを初期化
- conftest.pyによる共通セットアップの利用

## テストケース

### `test_create_and_list`

**目的**: プロセスインスタンスの作成と一覧表示の機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセス定義に基づいたインスタンスを2件作成する
3. list コマンドで一覧を表示する

**期待される結果**:
- 作成コマンドの終了コード: 0
- 作成コマンドの出力に "プロセスインスタンスを作成しました" が含まれること
- 一覧表示コマンドの終了コード: 0
- 一覧に作成した2件のプロセスインスタンスが含まれること
- インスタンスIDが表示されること
- 元となるプロセス定義名が表示されること
- ステータスが表示されること

### `test_show_process_instance`

**目的**: プロセスインスタンスの詳細表示機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセスインスタンスを作成する
3. show コマンドで詳細を表示する

**期待される結果**:
- 詳細表示コマンドの終了コード: 0
- 出力にインスタンスIDが含まれること
- 出力に元となるプロセス定義名が含まれること
- 出力にステータスが含まれること
- 出力に作成日時が含まれること
- 出力に開始日時が含まれること（未開始の場合は「未開始」と表示）

### `test_start_process_instance`

**目的**: プロセスインスタンスの開始機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセスインスタンスを作成する
3. start コマンドでインスタンスを開始する
4. show コマンドで確認する

**期待される結果**:
- 開始コマンドの終了コード: 0
- 開始コマンドの出力に "プロセスインスタンスを開始しました" が含まれること
- 詳細表示でステータスが "進行中" になっていること
- 開始日時が設定されていること

### `test_complete_process_instance`

**目的**: プロセスインスタンスの完了機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセスインスタンスを作成する
3. start コマンドでインスタンスを開始する
4. complete コマンドでインスタンスを完了する
5. show コマンドで確認する

**期待される結果**:
- 完了コマンドの終了コード: 0
- 完了コマンドの出力に "プロセスインスタンスを完了しました" が含まれること
- 詳細表示でステータスが "完了" になっていること
- 完了日時が設定されていること

### `test_cancel_process_instance`

**目的**: プロセスインスタンスのキャンセル機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセスインスタンスを作成する
3. start コマンドでインスタンスを開始する
4. cancel コマンドでインスタンスをキャンセルする
5. show コマンドで確認する

**期待される結果**:
- キャンセルコマンドの終了コード: 0
- キャンセルコマンドの出力に "プロセスインスタンスをキャンセルしました" が含まれること
- 詳細表示でステータスが "キャンセル" になっていること
- キャンセル日時が設定されていること

### `test_add_task_to_instance`

**目的**: プロセスインスタンスへのタスク追加機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセスインスタンスを作成する
3. add-task コマンドでインスタンスにタスクを追加する
4. show コマンドで確認する

**期待される結果**:
- タスク追加コマンドの終了コード: 0
- タスク追加コマンドの出力に "タスクをプロセスインスタンスに追加しました" が含まれること
- 詳細表示でインスタンスに追加したタスクが表示されること

### `test_delete_instance`

**目的**: プロセスインスタンスの削除機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. プロセスインスタンスを作成する
3. delete コマンドでインスタンスを削除する
4. list コマンドで削除されたことを確認する

**期待される結果**:
- 削除コマンドの終了コード: 0
- 削除コマンドの出力に "プロセスインスタンスを削除しました" が含まれること
- 一覧表示で削除したインスタンスが表示されないこと

### `test_filter_by_status`

**目的**: ステータスによるフィルタリング機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. 異なるステータスのインスタンスを複数作成する
   - 未開始のインスタンス
   - 開始したインスタンス
   - 完了したインスタンス
   - キャンセルしたインスタンス
3. 各ステータスでフィルタリングして一覧表示する

**期待される結果**:
- 各フィルタリングコマンドの終了コード: 0
- 未開始フィルタで未開始のインスタンスのみが表示されること
- 進行中フィルタで進行中のインスタンスのみが表示されること
- 完了フィルタで完了したインスタンスのみが表示されること
- キャンセルフィルタでキャンセルしたインスタンスのみが表示されること

### `test_error_handling`

**目的**: エラー処理が正しく機能することを確認する

**手順**:
1. 存在しないプロセス定義IDを指定してインスタンスを作成しようとする
2. 存在しないインスタンスIDを指定して show コマンドを実行する
3. 存在しないインスタンスIDを指定して delete コマンドを実行する
4. 既に開始されたインスタンスを再度開始しようとする
5. 完了済みのインスタンスをキャンセルしようとする

**期待される結果**:
- 各コマンドの終了コード: 1
- 適切なエラーメッセージが表示されること
  - "プロセス定義が見つかりません"
  - "プロセスインスタンスが見つかりません"
  - "このインスタンスは既に開始されています"
  - "完了済みのインスタンスはキャンセルできません" 