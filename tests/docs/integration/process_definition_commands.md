# プロセス定義管理コマンド結合テスト仕様

## 概要

プロセス定義管理コマンドの結合テストでは、以下の機能をテストします：

- データベースへのプロセス定義情報の保存と取得
- プロセス定義の作成、表示、更新、削除の一連の流れ
- プロセスステップの追加と削除
- プロセス定義間の関係（親子関係）
- バリデーションエラーの処理

この結合テストでは実際のデータベースアクセスを伴う処理をテストし、コマンドの機能が想定通りに動作することを確認します。

## テスト環境

- 一時的なSQLiteデータベースを使用
- 各テスト実行時にデータベースを初期化
- conftest.pyによる共通セットアップの利用

## テストケース

### `test_create_and_list`

**目的**: プロセス定義の作成と一覧表示の機能が正しく動作することを確認する

**手順**:
1. プロセス定義を2件作成する
2. list コマンドで一覧を表示する

**期待される結果**:
- 作成コマンドの終了コード: 0
- 作成コマンドの出力に "プロセス定義を作成しました" が含まれること
- 一覧表示コマンドの終了コード: 0
- 一覧に作成した2件のプロセス定義が含まれること
- プロセス定義IDが表示されること
- プロセス名が表示されること
- 説明が表示されること

### `test_show_process_definition`

**目的**: プロセス定義の詳細表示機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. show コマンドで詳細を表示する

**期待される結果**:
- 詳細表示コマンドの終了コード: 0
- 出力にプロセス定義IDが含まれること
- 出力にプロセス名が含まれること
- 出力に説明が含まれること
- 出力に作成日時が含まれること
- 出力に更新日時が含まれること

### `test_update_process_definition`

**目的**: プロセス定義の更新機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. update コマンドで名前と説明を更新する
3. show コマンドで確認する

**期待される結果**:
- 更新コマンドの終了コード: 0
- 更新コマンドの出力に "プロセス定義を更新しました" が含まれること
- 詳細表示で更新された名前と説明が表示されること

### `test_add_step_to_process`

**目的**: プロセス定義へのステップ追加機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. add-step コマンドでステップを追加する
3. show コマンドで確認する

**期待される結果**:
- ステップ追加コマンドの終了コード: 0
- ステップ追加コマンドの出力に "ステップをプロセス定義に追加しました" が含まれること
- 詳細表示で追加したステップが表示されること
- ステップの順序が表示されること

### `test_update_step`

**目的**: プロセスステップの更新機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. ステップを追加する
3. update-step コマンドでステップの内容を更新する
4. show コマンドで確認する

**期待される結果**:
- ステップ更新コマンドの終了コード: 0
- ステップ更新コマンドの出力に "ステップを更新しました" が含まれること
- 詳細表示で更新されたステップ内容が表示されること

### `test_remove_step_from_process`

**目的**: プロセス定義からのステップ削除機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. ステップを追加する
3. remove-step コマンドでステップを削除する
4. show コマンドで確認する

**期待される結果**:
- ステップ削除コマンドの終了コード: 0
- ステップ削除コマンドの出力に "ステップをプロセス定義から削除しました" が含まれること
- 詳細表示で削除したステップが表示されないこと

### `test_create_child_process`

**目的**: 親子関係のあるプロセス定義の作成機能が正しく動作することを確認する

**手順**:
1. 親プロセス定義を作成する
2. 親IDを指定して子プロセス定義を作成する
3. 親プロセスの show コマンドで確認する
4. 子プロセスの show コマンドで確認する

**期待される結果**:
- 子プロセス作成コマンドの終了コード: 0
- 親プロセスの詳細表示に子プロセスの情報が含まれること
- 子プロセスの詳細表示に親プロセスの情報が含まれること

### `test_delete_process_definition`

**目的**: プロセス定義の削除機能が正しく動作することを確認する

**手順**:
1. プロセス定義を作成する
2. delete コマンドでプロセス定義を削除する
3. list コマンドで削除されたことを確認する

**期待される結果**:
- 削除コマンドの終了コード: 0
- 削除コマンドの出力に "プロセス定義を削除しました" が含まれること
- 一覧表示で削除したプロセス定義が表示されないこと

### `test_delete_with_force`

**目的**: 子プロセスを持つプロセス定義の強制削除機能が正しく動作することを確認する

**手順**:
1. 親プロセス定義を作成する
2. 子プロセス定義を作成する
3. 強制削除なしで親プロセスの削除を試みる
4. 強制削除フラグを使用して親プロセスを削除する
5. list コマンドで削除されたことを確認する

**期待される結果**:
- 強制削除なしの場合の終了コード: 1
- 強制削除なしの場合のエラーメッセージに "子プロセスが存在するため削除できません" が含まれること
- 強制削除ありの場合の終了コード: 0
- 強制削除ありの場合の出力に "プロセス定義を削除しました" が含まれること
- 一覧表示で親プロセス定義が表示されないこと
- 一覧表示で子プロセス定義も表示されないこと（カスケード削除）

### `test_error_handling`

**目的**: エラー処理が正しく機能することを確認する

**手順**:
1. 存在しないプロセス定義IDを指定して show コマンドを実行する
2. 存在しないプロセス定義IDを指定して update コマンドを実行する
3. 存在しないプロセス定義IDを指定して delete コマンドを実行する
4. 存在しないステップIDを指定して update-step コマンドを実行する
5. 存在しないステップIDを指定して remove-step コマンドを実行する
6. 無効なステップ順序（例: 負の数）を指定してステップを追加しようとする

**期待される結果**:
- 各コマンドの終了コード: 1
- 適切なエラーメッセージが表示されること
  - "プロセス定義が見つかりません"
  - "ステップが見つかりません"
  - "ステップ順序は正の整数である必要があります" 