# 目標コマンド統合テスト仕様書

## 概要

この文書では、タスク管理システムにおける目標コマンドの統合テストの仕様を定義します。
統合テストの目的は、実際のデータベース操作を含む複数のコマンドの相互作用を検証することです。

## テスト環境

- テストでは一時的なSQLiteデータベースを使用します
- 各テストの前にテスト用データベースが設定され、親目標（ID:1）が作成されます
- 各テストの終了後にはデータベースがクリーンアップされます

## テストケース

### 1. 目標作成と一覧表示テスト (`test_create_and_list`)

**目的:** 目標の作成と一覧表示機能が正常に動作することを確認する

**手順:**
1. 新しい目標を作成（タイトル、説明、測定基準、目標値を指定）
2. 目標一覧を表示し、作成した目標が一覧に表示されることを確認

**検証項目:**
- 目標作成コマンドが成功すること（終了コード0）
- 目標作成後のメッセージに「作成されました」が含まれること
- 目標一覧に作成した目標のタイトルが表示されること

### 2. 単純な目標削除テスト (`test_simple_delete`)

**目的:** 依存関係のない単独の目標を正常に削除できることを確認する

**手順:**
1. テスト用の削除対象目標を作成
2. 目標一覧から作成した目標のIDを特定
3. 特定したIDの目標を削除
4. 削除後に目標の詳細表示を試みる

**検証項目:**
- 目標削除コマンドが成功すること（終了コード0）
- 削除後のメッセージに「削除しました」が含まれること
- 削除後に目標の詳細表示を試みた際にエラーとなること（見つからない）

### 3. サブ目標作成テスト (`test_create_subobjective`)

**目的:** 親目標の下にサブ目標を正常に作成できることを確認する

**手順:**
1. セットアップで作成された親目標（ID:1）の下にサブ目標を作成
2. 目標一覧でサブ目標が表示されることを確認
3. 親目標の詳細表示で、子目標としてサブ目標が表示されることを確認

**検証項目:**
- サブ目標作成コマンドが成功すること（終了コード0）
- 目標一覧にサブ目標が表示されること
- 親目標の詳細表示に子目標としてサブ目標が含まれること

### 4. 強制削除テスト (`test_delete_with_force`)

**目的:** 子目標を持つ親目標の削除が、--forceオプションの有無によって適切に処理されることを確認する

**手順:**
1. 親目標（ID:1）の下にサブ目標を作成（すでに存在する場合は作成をスキップ）
2. --forceオプションなしで親目標の削除を試みる
3. --forceオプション付きで親目標の削除を再試行
4. 削除後に親目標が存在しないことを確認

**検証項目:**
- --forceオプションなしの削除は失敗すること（終了コード1）
- エラーメッセージに「子目標があります」が含まれること
- --forceオプション付きの削除は成功すること（終了コード0）
- 削除後に親目標が見つからないこと

### 5. 目標更新テスト (`test_update_objective`)

**目的:** 目標の各フィールド（タイトル、説明、指標、目標値、現在値、期限）を正常に更新できることを確認する

**手順:**
1. テスト用の目標を作成（更新前の値を設定）
2. 目標一覧から作成した目標のIDを特定
3. タイトルを更新して確認
4. 説明を更新して確認
5. 指標と目標値を更新して確認
6. 現在値と期限を更新して確認
7. 更新後の目標詳細を表示し、すべての更新が反映されていることを確認

**検証項目:**
- 各更新コマンドが成功すること（終了コード0）
- 更新後のメッセージに「更新しました」が含まれること
- 最終的に目標詳細を表示した際に、すべての更新した値が正しく表示されること

### 6. 状態変更テスト (`test_status_command`)

**目的:** 目標の状態を正常に変更できることを確認する

**手順:**
1. テスト用の目標を作成
2. 目標一覧から作成した目標のIDを特定
3. 初期状態（「進行中」）を確認
4. 状態を「達成」に変更して確認
5. 状態を「未達成」に変更して確認
6. 状態を「中止」に変更して確認

**検証項目:**
- 各状態変更コマンドが成功すること（終了コード0）
- 変更後に目標詳細を表示した際に、変更した状態が正しく表示されること

### 7. 一覧フィルタリングテスト (`test_list_filter_by_status`)

**目的:** 目標一覧のステータスによるフィルタリングが正常に動作することを確認する

**手順:**
1. 異なる状態の目標を複数作成（進行中、達成、未達成、中止）
2. 「進行中」の目標のみをフィルタリングして表示
3. 「達成」の目標のみをフィルタリングして表示
4. 「未達成」の目標のみをフィルタリングして表示
5. 「中止」の目標のみをフィルタリングして表示

**検証項目:**
- 各フィルタリングコマンドが成功すること（終了コード0）
- 「進行中」フィルタでは「進行中の目標」のみが表示されること
- 「達成」フィルタでは「達成済みの目標」のみが表示されること
- 「未達成」フィルタでは「未達成の目標」のみが表示されること
- 「中止」フィルタでは「中止した目標」のみが表示されること
- 各フィルタで、他の状態の目標は表示されないこと

### 8. エラー処理テスト (`test_error_handling`)

**目的:** 無効なパラメータや不正な操作に対するエラー処理が適切に行われることを確認する

**手順:**
1. 存在しない目標の表示を試みる
2. 存在しない目標の更新を試みる
3. 存在しない目標の削除を試みる
4. 存在しない目標の状態変更を試みる
5. 不正な状態値でstatusコマンドを実行
6. 不正な状態値でupdateコマンドを実行
7. 存在しない親目標IDを指定してサブ目標を作成

**検証項目:**
- 各操作が適切に失敗すること（終了コード != 0）
- 存在しない目標の操作時に「見つかりません」というエラーメッセージが表示されること
- 不正な状態値の指定時に「無効な状態」というエラーメッセージが表示されること
- 存在しない親目標IDの指定時に適切なエラーメッセージが表示されること

## 実装の詳細

- 作成した目標のIDは動的に取得します（目標一覧からIDを抽出）
- 各テストは独立して実行可能で、他のテストの結果に依存しません
- セットアップとクリーンアップは自動的に実行され、テスト環境の一貫性を保証します

## テスト対象ファイル

- 統合テスト実装: `tests/integration/test_objective.py`
- テスト設定: `tests/conftest.py`, `tests/integration/conftest.py`

## テスト実行方法
```bash
./run_tests.sh integration
```

## ユニットテストとの違い
- 実際のデータベース操作を含む
- コマンド間の相互作用を検証
- 目標の親子関係などの複雑な関係性を検証

## 注意事項
- 各テストは `setup` メソッドで独立した環境を準備
- テスト順序に依存しないよう設計
- `test_db` フィクスチャが一時データベースの作成と後処理を自動化
- コマンドオプションはアプリケーションの実装に合わせて適宜調整が必要 